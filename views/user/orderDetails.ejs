<!DOCTYPE html>
<html>
<head>
  <title>Order Details</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<%- include("../partials/header") %>

<div class="container">

  <h2>Order Details</h2>

  <div class="order-card">

    <img src="<%= medicine.image %>" width="150" />

    <h3><%= medicine.name %></h3>
    <p><strong>Brand:</strong> <%= medicine.brand %></p>

    <% if (medicine.discount > 0) { %>
      <p><strong>Original Price:</strong> ₹<%= medicine.price %></p>
      <p><strong>Discount:</strong> <%= medicine.discount %>%</p>
      <p><strong>Final Price:</strong>
         ₹<%= (medicine.price - (medicine.price * medicine.discount / 100)).toFixed(2) %>
      </p>
    <% } else { %>
      <p><strong>Price:</strong> ₹<%= medicine.price %></p>
    <% } %>
    <p><strong>Total Amount:</strong> ₹<span id="totalPrice">0</span></p>

  <div class="form">
  <form action="/order/confirm" method="post">
  <input type="hidden" name="medicineId" value="<%= medicine._id %>">

  <label>Quantity</label>
  <input type="number" name="quantity" min="1" required>

  <label>Delivery Address</label>
  <textarea name="address" required placeholder="Enter full address"></textarea>
  <button type="button" id="geoBtn">Use Current Location</button>

  <input type="hidden" id="latitude" name="latitude">
  <input type="hidden" id="longitude" name="longitude">

  <textarea id="geoText" readonly placeholder="Detected GPS location will appear here..."></textarea>

  <button type="submit" class="buy-btn">Place Order</button>
</form>
</div>
  </div>

</div>
<script>
document.getElementById("geoBtn").onclick = () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // store in hidden input
      document.getElementById("latitude").value = lat;
      document.getElementById("longitude").value = lon;

      // show text
      document.getElementById("geoText").value = 
        `Latitude: ${lat}\nLongitude: ${lon}`;
    });
  } else {
    alert("Geolocation Not Supported");
  }
};

const price = <%= medicine.discount > 0 
  ? (medicine.price - (medicine.price * medicine.discount / 100)) 
  : medicine.price 
%>;

const qtyInput = document.querySelector("input[name='quantity']");
const totalPriceSpan = document.getElementById("totalPrice");

// Function to update total
function updateTotal() {
  const qty = Number(qtyInput.value) || 0;
  totalPriceSpan.textContent = (price * qty).toFixed(2);
}

// Update total whenever quantity changes
qtyInput.addEventListener("input", updateTotal);

// Trigger once on load
updateTotal();
</script>

<%- include("../partials/footer") %>

</body>
</html>
